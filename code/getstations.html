<!--The JavaScript same-origin policy (Links to an external site) aims to prevent cross-site request forgery by limiting how resources on
different hosts can interact with each other. Knowing this, why is it possible for your website to load and display data from the BART API?
Include your answer as a comment within the HTML markup of your created website. -->

<!-- Answer Part#5: BART APIs work on my website because the BART API server allows CORS (Cross Origin Access) in its configuration 
  We can observe this in the payload of the response of the request. in the Response Headers we can see a property access-control-allow-origin: *,
The "*" signifies it allows all CORS -->

<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  </head>
  <body>
    <h1 id="greeting"></h1>
    <h1>BART Stations List</h1>
    <section style="display: flex">
      <section
        style="display: flex; width: 70vw; float: left; flex-direction: column"
      >
        <section style="display: flex">
          <section style="padding-right: 2%">
            <label for="src-station-names">Choose a dept. station</label>
            <select
              onchange="getStationDetails(this);"
              id="srcstationsList"
            ></select>
          </section>
          <section style="padding-right: 2%">
            <label for="dest-station-names">Choose a arrival station</label>
            <select
              onchange="getTripDetails(this)"
              id="deststationsList"
            ></select>
          </section>
        </section>
        <section
          style="padding-right: 2%; padding-left: 2%; padding-top: 10%"
          id="tripDetails"
        ></section>
        <section style="padding: 2%" id="countDownTimer"></section>
      </section>
      <aside id="stationDetails">
        <h2 id="srcHeading"></h2>
        <p id="srcName"></p>
        <p id="srcAbbr"></p>
        <p id="srcAddress"></p>
        <p id="srcCity"></p>
        <p id="srcCounty"></p>
        <p id="srcState"></p>
        <p id="srcZipcode"></p>
      </aside>
    </section>
  </body>
  <script>
    let srcstationsArray = [];
    let deststationsArray = [];
    let stationData = {};
    let tripDetails = {};
    let selectedSrcStation = "";
    let selectedDestStation = "";
    let tripsArray = new Array();
    let closestScheduleTimer = null;
    generateGreeting();
    $.get("http://localhost:5000/stationsTest", function (data, status) {
      srcstationsArray = data.data.root.stations[0].station;
      stationsList("srcstationsList");
    });
    function stationsList(id) {
      let elm = document.getElementById(id), // get the select
        df = document.createDocumentFragment(); // create a document fragment to hold the options while we create them
      let stationsArray = [];
      if (id == "srcstationsList") {
        stationsArray = srcstationsArray;
      } else {
        stationsArray = deststationsArray;
      }

      for (var i = 0; i < stationsArray.length; i++) {
        if (i == 0) {
          var option = document.createElement("option"); // create the option element
          option.value = i; // set the value property
          option.appendChild(document.createTextNode("select a station")); // set the textContent in a safe way.
          df.appendChild(option); // append the option to the document fragment
        } else {
          var option = document.createElement("option"); // create the option element
          option.value = i; // set the value property
          option.appendChild(document.createTextNode(stationsArray[i].name[0])); // set the textContent in a safe way.
          df.appendChild(option); // append the option to the document fragment
        }
      }
      elm.appendChild(df); // append the document fragment to the DOM. this is the better way rather than setting innerHTML a bunch of times (or even once with a long string)
    }

    function getStationDetails(sel) {
      deststationsArray = [];
      const destStationElement = document.getElementById("deststationsList");
      $(destStationElement).children().remove();
      if (sel.value != 0) {
        const source = srcstationsArray[sel.value].abbr[0];
        selectedSrcStation = source;
        deststationsArray = srcstationsArray.filter((element) => {
          return element.abbr !== srcstationsArray[sel.value].abbr[0];
        });
        stationsList("deststationsList");
        $.get(
          "http://localhost:5000/stationTest/source/" + source,
          function (data, status) {
            stationData = data.station;
            loadStationDetails();
          }
        );
      }
    }

    function getTripDetails(sel) {
      if (sel.value != 0) {
        selectedDestStation = deststationsArray[sel.value].abbr;
        $.get(
          "http://localhost:5000/tripsTest/source/" +
            selectedSrcStation +
            "/dest/" +
            selectedDestStation,
          function (data, status) {
            tripDetails = data.trip.schedule[0].request[0].trip;
            loadTripDetails();
          }
        );
      }
    }

    function loadStationDetails() {
      let stationDetailsDOM = document.getElementById("stationDetails");
      stationDetailsDOM.style =
        "width: 25vw; float: right; padding-left: 10px; border-width: 2px; border-color: black; border-style: solid;";

      let srcHeading = document.getElementById("srcHeading");
      srcHeading.innerHTML = "Source Station details";
console.log(stationData)
      let srcName = document.getElementById("srcName");
      srcName.innerHTML = "Name: " + stationData[0].name[0];

      let srcAbbr = document.getElementById("srcAbbr");
      srcAbbr.innerHTML = "Abbr: " + stationData[0].abbr[0];

      let srcAddress = document.getElementById("srcAddress");
      srcAddress.innerHTML = "Address: " + stationData[0].address[0];

      let srcCity = document.getElementById("srcCity");
      srcCity.innerHTML = "City: " + stationData[0].city[0];

      let srcCounty = document.getElementById("srcCounty");
      srcCounty.innerHTML = "County: " + stationData[0].county[0];

      let srcState = document.getElementById("srcState");
      srcState.innerHTML = "State: " + stationData[0].state[0];

      let srcZipcode = document.getElementById("srcZipcode");
      srcZipcode.innerHTML = "City: " + stationData[0].zipcode[0];
    }

    function loadTripDetails() {
      const tripDetailsElement = document.getElementById("tripDetails");
      $(tripDetailsElement).children().remove();
      let tripHeading = document.createElement("h2"); // create the option element
      tripHeading.innerHTML =
        "Trip details between: " +
        selectedSrcStation +
        "-" +
        selectedDestStation; // set the value property
      let tableElement = document.createElement("div");
      tableElement.id = "dvTable";
      tripDetailsElement.appendChild(tripHeading);
      tripDetailsElement.appendChild(tableElement);
      generateTable();
    }

    function generateTable() {
      //Build an array containing Customer records.
      closestScheduleTimer = null;
      tripsArray = [];
      tripsArray.push(["Sl No", "Dept. Time", "Fare", "ETA"]);
      let index = 1;
      tripDetails.forEach((element) => {
        if (closestScheduleTimer == null) {
          console.log(element.$);
          console.log(element.$["origTimeMin"]);
          let dateString = element.$["origTimeMin"];
          let timeParts = dateString.split(":");
          let hours = parseInt(timeParts[0], 10);
          let minutes = parseInt(timeParts[1], 10);

          if (dateString.indexOf("PM") !== -1 && hours < 12) {
            hours = hours + 12;
          }

          var dateObjSchedule = new Date();
          dateObjSchedule.setHours(hours);
          dateObjSchedule.setMinutes(minutes);
          dateObjSchedule.setSeconds(0);
          dateObjSchedule.setMilliseconds(0);
          let now = Date.now();
          if (dateObjSchedule - now > 0) {
            closestScheduleTimer = dateObjSchedule;
          }
        }
        tripsArray.push([
          index,
          element.$["origTimeMin"],
          element.$["fare"],
          element.$["destTimeMin"],
        ]);
      });

      //Create a HTML Table element.
      var table = document.createElement("TABLE");
      table.border = "1";

      //Get the count of columns.
      var columnCount = tripsArray[0].length;

      //Add the header row.
      var row = table.insertRow(-1);
      for (var i = 0; i < columnCount; i++) {
        var headerCell = document.createElement("TH");
        headerCell.innerHTML = tripsArray[0][i];
        row.appendChild(headerCell);
      }

      //Add the data rows.
      for (var i = 1; i < tripsArray.length; i++) {
        row = table.insertRow(-1);
        for (var j = 0; j < columnCount; j++) {
          var cell = row.insertCell(-1);
          cell.innerHTML = tripsArray[i][j];
        }
      }

      var dvTable = document.getElementById("dvTable");
      dvTable.innerHTML = "";
      dvTable.appendChild(table);
    }

    setInterval(updateTripDetails, 30000);
    setInterval(countDownTimer, 1000);

    function updateTripDetails() {
      const tableElement = document.getElementById("dvTable");
      if (tableElement != null) {
        $.get(
          "http://localhost:5000/tripsTest/source/" +
            selectedSrcStation +
            "/dest/" +
            selectedDestStation,
          function (data, status) {
            tripDetails = data.trip.schedule[0].request[0].trip;
            loadTripDetails();
          }
        );
      }
    }
    function countDownTimer() {
      const tableElement = document.getElementById("dvTable");
      if (tableElement != null) {
        if (closestScheduleTimer - Date.now() > 0) {
          let countDownTimerElement = document.getElementById("countDownTimer");
          const timediff = Math.floor(
            (closestScheduleTimer.getTime() - Date.now()) / 1000
          );
          const minutes = Math.floor(timediff / 60); // whole minutes
          const seconds = timediff % 60; // remaining seconds
          countDownTimerElement.innerHTML =
            "<h3>" +
            "Countdown Timer to next train: " +
            minutes +
            ":" +
            seconds +
            "</h3>";
        } else {
          updateTripDetails();
        }
      }
    }
    function generateGreeting() {
      const greeting = document.getElementById("greeting");
      if (localStorage.getItem("visitCount") == null) {
        greeting.innerHTML =
          "Hi, Welcome!, you've visited this page " + 1 + " time";
        localStorage.setItem("visitCount", 1);
      } else {
        let visitCount = parseInt(localStorage.getItem("visitCount")) + 1;
        localStorage.setItem("visitCount", visitCount);
        greeting.innerHTML =
          "Hi, Welcome again!, you've visited this page " +
          visitCount +
          " times";
      }
    }
  </script>
  <footer></footer>
</html>
